<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>なずなポータルサイト - ホーム</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- PWA対応メタタグ -->
    <meta name="theme-color" content="#4a7c59">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="なずなポータル">
    <meta name="msapplication-TileColor" content="#4a7c59">
    <meta name="msapplication-config" content="browserconfig.xml">
    <meta name="application-name" content="なずなポータル">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- iOS 16.4+ PWA プッシュ通知対応 -->
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-touch-fullscreen" content="yes">
    <meta name="apple-mobile-web-app-orientations" content="portrait">
    <meta name="web-app-origin-association" content="https://nazuna-portal.web.app">
    
    <!-- iOS対応 -->
    <link rel="apple-touch-icon" href="./images/icon.png">
    <link rel="apple-touch-icon" sizes="152x152" href="./images/icon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="./images/icon.png">
    <link rel="apple-touch-icon" sizes="167x167" href="./images/icon.png">
    
    <!-- Windows対応 -->
    <meta name="msapplication-TileImage" content="./images/icon.png">  
    <meta name="msapplication-square70x70logo" content="./images/icon.png">
    <meta name="msapplication-square150x150logo" content="./images/icon.png">
    <meta name="msapplication-wide310x150logo" content="./images/icon.png">
    <meta name="msapplication-square310x310logo" content="./images/icon.png">
    <!-- Supabase CDN -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-messaging-compat.js"></script>
    <!-- Firebase初期化 -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Firebase設定
            const firebaseConfig = {
                apiKey: "AIzaSyDQ8g88Z4rW-nX6TzCGjxFvfDptju4fOIc",
                authDomain: "nazuna-portal.firebaseapp.com",
                projectId: "nazuna-portal",
                storageBucket: "nazuna-portal.firebasestorage.app",
                messagingSenderId: "181514532945",
                appId: "1:181514532945:web:65043ee5d7d435a7af6070"
            };
            
            // Firebase初期化
            if (typeof firebase !== 'undefined') {
                if (!firebase.apps.length) {
                    try {
                        firebase.initializeApp(firebaseConfig);
                        console.log('Firebase initialized');
                        
                        // Firebase Messaging初期化
                        if (firebase.messaging.isSupported()) {
                            const messaging = firebase.messaging();
                            console.log('Firebase Messaging initialized');
                            
                            // VAPIDキー設定
                            const vapidKey = "BCEnp7nRdNubcooPI86iEEFqavkUxRal0t3AKkjsC1nB-PYLOUiE-EnGITJKfdANSRCG7zjyRzR6ERX3ZT0tZMQ";
                            
                            // 通知許可の要求とトークン取得
                            Notification.requestPermission().then((permission) => {
                                if (permission === 'granted') {
                                    console.log('Notification permission granted');
                                    
                                    // FCMトークン取得
                                    messaging.getToken({ vapidKey: vapidKey })
                                        .then((token) => {
                                            if (token) {
                                                console.log('FCM Token:', token);
                                                // トークンをサーバーに送信する処理
                                                if (window.notificationManager) {
                                                    window.notificationManager.registerDevice(token);
                                                }
                                            } else {
                                                console.log('No token available');
                                            }
                                        })
                                        .catch((err) => {
                                            console.error('FCM token error:', err);
                                            
                                            // iOS PWA環境の診断情報
                                            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                                            const isPWA = window.matchMedia('(display-mode: standalone)').matches || 
                                                        window.navigator.standalone === true;
                                            
                                            if (isIOS && isPWA) {
                                                console.log('iOS PWA環境でFCMトークン取得に失敗しました。診断情報を表示します。');
                                                if (window.notificationManager) {
                                                    const supportInfo = window.notificationManager.checkIOSPWASupport();
                                                    console.log('iOS PWA診断情報:', supportInfo);
                                                }
                                            }
                                        });
                                    
                                    // フォアグラウンドメッセージの処理
                                    messaging.onMessage((payload) => {
                                        console.log('Foreground message received:', payload);
                                        
                                        // NotificationManagerに処理を委譲
                                        if (window.notificationManager) {
                                            window.notificationManager.handleForegroundMessage(payload);
                                        } else {
                                            // フォールバック処理
                                            const notification = new Notification(payload.notification.title, {
                                                body: payload.notification.body,
                                                icon: payload.notification.icon || '/images/icon-192x192.png'
                                            });
                                        }
                                    });
                                }
                            });
                        } else {
                            console.warn('Firebase Messaging not supported in this browser');
                            
                            // iOS PWAの場合は診断情報を表示
                            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                            const isPWA = window.matchMedia('(display-mode: standalone)').matches || 
                                        window.navigator.standalone === true;
                            
                            if (isIOS && isPWA && window.notificationManager) {
                                const supportInfo = window.notificationManager.checkIOSPWASupport();
                                console.log('iOS PWA環境でFirebase Messagingがサポートされていません。診断情報:', supportInfo);
                            }
                        }
                    } catch (error) {
                        console.error('Firebase initialization error:', error);
                    }
                }
            } else {
                console.warn('Firebase SDK not loaded');
            }
        });
    </script>
</head>
<body>
    <!-- サイドバー -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>なずなポータル</h2>
            <p>みんなでつくる学校生活</p>
            <button class="sidebar-close-btn" id="sidebar-close-btn" aria-label="メニューを閉じる">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <nav class="sidebar-nav">
            <ul>
                <li>
                    <a href="index.html" class="active">
                        <i class="fas fa-home"></i>
                        <span>ホーム</span>
                    </a>
                </li>
                <li>
                    <a href="council.html">
                        <i class="fas fa-users"></i>
                        <span>生徒会紹介</span>
                    </a>
                </li>
                <li>
                    <a href="clubs.html">
                        <i class="fas fa-running"></i>
                        <span>部活動</span>
                    </a>
                </li>
                <li>
                    <a href="forum.html">
                        <i class="fas fa-comments"></i>
                        <span>なずなフォーラム</span>
                    </a>
                </li>
                <li>
                    <a href="news.html">
                        <i class="fas fa-bell"></i>
                        <span>お知らせ</span>
                    </a>
                </li>
                <li>
                    <a href="survey.html">
                        <i class="fas fa-poll"></i>
                        <span>アンケート</span>
                    </a>
                </li>
            </ul>
        </nav>
    </div>
    
    <!-- サイドバーオーバーレイ -->
    <div class="sidebar-overlay" id="sidebar-overlay"></div>
    <header>
        <nav class="navbar">
            <div class="nav-container">
                <button class="hamburger" id="hamburger" aria-label="メニューを開く" aria-expanded="false">
                    <span aria-hidden="true"></span>
                    <span aria-hidden="true"></span>
                    <span aria-hidden="true"></span>
                </button>
                <h1 class="logo">なずなポータル</h1>
                <div class="nav-spacer"></div>
            </div>
        </nav>
    </header>

    <main>
        <!-- ヒーローセクション -->
        <section class="hero">
            <div class="hero-content">
                <div class="hero-text">
                    <h1>みんなでつくる学校生活</h1>
                    <p class="hero-subtitle">なずなポータルへようこそ</p>
                    <p class="hero-description">
                        私たちは生徒一人ひとりの声を大切にし、<br>
                        より良い学校生活の実現を目指しています。
                    </p>
                    <div class="hero-buttons">
                        <a href="forum.html" class="btn btn-primary">
                            <i class="fas fa-comments"></i>
                            意見を投稿する
                        </a>
                        <a href="council.html" class="btn btn-secondary">
                            <i class="fas fa-users"></i>
                            生徒会について
                        </a>
                    </div>
                </div>
                <div class="hero-image">
                    <div class="hero-graphic">
                        <i class="fas fa-graduation-cap"></i>
                    </div>
                </div>
            </div>
        </section>

        <!-- 機能紹介セクション -->
        <section class="features">
            <div class="container">
                <h2 class="section-title">主な機能</h2>
                <div class="features-grid">
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <h3>生徒会紹介</h3>
                        <p>生徒会メンバーの紹介と活動内容をご覧いただけます。</p>
                        <a href="council.html" class="feature-link">詳しく見る <i class="fas fa-arrow-right"></i></a>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-running"></i>
                        </div>
                        <h3>部活動紹介</h3>
                        <p>各部活動の詳細情報や活動スケジュールを確認できます。</p>
                        <a href="clubs.html" class="feature-link">詳しく見る <i class="fas fa-arrow-right"></i></a>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-comments"></i>
                        </div>
                        <h3>なずなフォーラム</h3>
                        <p>匿名で意見や要望を投稿し、生徒会と対話できます。</p>
                        <a href="forum.html" class="feature-link">詳しく見る <i class="fas fa-arrow-right"></i></a>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-bell"></i>
                        </div>
                        <h3>お知らせ</h3>
                        <p>学校行事や生徒会からの重要なお知らせをチェックできます。</p>
                        <a href="news.html" class="feature-link">詳しく見る <i class="fas fa-arrow-right"></i></a>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-poll"></i>
                        </div>
                        <h3>アンケート・投票</h3>
                        <p>学校生活に関するアンケートや投票に参加できます。</p>
                        <a href="survey.html" class="feature-link">詳しく見る <i class="fas fa-arrow-right"></i></a>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <h3>PWA対応</h3>
                        <p>スマートフォンにアプリとしてインストールして利用できます。</p>
                        <a href="#" class="feature-link" id="install-pwa">インストール <i class="fas fa-download"></i></a>
                    </div>
                </div>
            </div>
        </section>

        <!-- 最新情報セクション -->
        <section class="latest-updates">
            <div class="container">
                <h2 class="section-title">最新情報</h2>
                <div class="updates-grid">
                    <div class="update-card news-update">
                        <div class="update-header">
                            <i class="fas fa-bell"></i>
                            <span>最新のお知らせ</span>
                        </div>
                        <div class="update-content" id="latest-news">
                            <div class="loading">読み込み中...</div>
                        </div>
                        <a href="news.html" class="update-link">すべて見る</a>
                    </div>
                    
                    <div class="update-card forum-update">
                        <div class="update-header">
                            <i class="fas fa-comments"></i>
                            <span>最新の投稿</span>
                        </div>
                        <div class="update-content" id="latest-posts">
                            <div class="loading">読み込み中...</div>
                        </div>
                        <a href="forum.html" class="update-link">フォーラムを見る</a>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <div class="footer-content">
            <div class="footer-section">
                <h3>なずなポータル</h3>
                <p>みんなでつくる学校生活</p>
            </div>
            <div class="footer-section">
                <h4>リンク</h4>
                <ul>
                    <li><a href="council.html">生徒会紹介</a></li>
                    <li><a href="clubs.html">部活動</a></li>
                    <li><a href="forum.html">なずなフォーラム</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h4>お問い合わせ</h4>
                <p>生徒会室まで</p>
                <p>平日 12:30-13:00</p>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2025 市川学園生徒会. All rights reserved.</p>
            <p class="admin-link"><a href="admin.html">管理者ログイン</a></p>
        </div>
    </footer>

    <script src="js/config.js"></script>
    <script src="js/supabase-queries.js"></script>
    <script src="js/app.js"></script>
    <script src="js/firebase-config.js"></script>
    <script src="js/pwa-install.js"></script>
    <script src="js/pwa-update.js"></script>
</body>
</html>