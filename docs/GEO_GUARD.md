## 位置情報ガード設定ガイド

この機能は、ページ表示前にブラウザの位置情報を取得し、許可ゾーン外・取得拒否・エラー時は指定のエラーページへ遷移させます。

重要: 位置情報の取得にはユーザーの許可が必要です。初回アクセス時にブラウザの許可ダイアログが表示されます。ユーザーが拒否した場合は安全側の動作としてエラーページに遷移します。

許可リクエスト前に、取得の目的をユーザーへ明示することを推奨します（本実装では確認ダイアログを表示可能）。

### 1) 有効化/対象ページの選択

`js/config.js` の `CONFIG.SECURITY.GEO_GUARD.ENABLED_PAGES` にて、ページ単位で有効化を設定します。

```javascript
// js/config.js
SECURITY: {
  GEO_GUARD: {
    ENABLED_PAGES: {
      // true にしたページのみガードを有効化
      admin: false,
      forum: false,
      index: false,
      council: false,
      clubs: true, // 例: clubs を有効化
      news: false,
      survey: false,
      'member-detail': false
    },
    // ...
  }
}
```

ページ名は URL のファイル名（例: `forum.html` -> `forum`）が基準です。`index.html` は `index` として扱われます。

### 2) 許可ゾーンの設定

許可ゾーンは中心座標と半径[m]で定義する円領域です。複数指定できます。

```javascript
// js/config.js
SECURITY: {
  GEO_GUARD: {
    ALLOWED_ZONES: [
      { lat: 35.000000, lng: 139.000000, radiusMeters: 300 },
      // 複数追加可
    ],
    REDIRECT_PATH: '404.html',     // 範囲外/拒否時の遷移先
    TIMEOUT_MS: 6000,              // 取得タイムアウト(ms)
    ENABLE_HIGH_ACCURACY: false    // 高精度モード（消費電力増）
  }
}
```

座標の取得方法:
- Google マップ等で対象地点の緯度経度を取得
- 端末上で現在地から取得してログなどに出力（開発時のみ）

### 3) 挙動の要点

- ブラウザ許可ダイアログで「許可」しない場合 → `REDIRECT_PATH` へ遷移
- 位置情報 API が未対応/エラー/タイムアウト → `REDIRECT_PATH` へ遷移
- 取得した位置がいずれの許可ゾーンにも該当しない → `REDIRECT_PATH` へ遷移
- いずれかの許可ゾーンに含まれる → ページ表示継続

#### 許可の目的説明（同意取得）

`CONFIG.SECURITY.GEO_GUARD.CONSENT_MESSAGE` に文言を設定すると、ブラウザの許可ダイアログが出る前に確認ダイアログで目的説明を行い、同意した場合のみ位置情報の取得を試みます。

例:

```javascript
CONSENT_MESSAGE: 'このページでは校内限定コンテンツを保護するため、位置情報の取得許可が必要です。位置情報は滞在中の判定にのみ使用し、保存しません。位置情報の取得を許可しますか？'
```

### 4) テスト手順（推奨）

1. `ENABLED_PAGES` で対象ページを `true` にする
2. `ALLOWED_ZONES` を一時的に現在地付近に設定（半径大きめ: 1000〜2000m）
3. 当該ページへアクセス
   - 許可→表示継続、拒否→`REDIRECT_PATH` にリダイレクト
4. 半径を運用値に絞り、再テスト

### 5) iOS等のモバイル環境での動作

本実装はiOS Safari、Android Chrome等のモバイルブラウザでも動作します。

#### iOS Safariでの動作
- Permissions API (`navigator.permissions.query`) は未対応または制限があるため、フォールバック処理で同意ダイアログを表示します。
- ユーザー操作がないタブでの位置情報取得は制限される場合があります。ページ読み込み直後の自動実行は動作しますが、バックグラウンドタブでは動作しないことがあります。
- 位置情報の取得にはユーザーの明示的な許可が必要です。ブラウザの許可ダイアログが表示されます。

#### Android Chrome等での動作
- Permissions APIが利用可能な場合は、事前に許可状態を確認してから同意ダイアログを表示します。
- 位置情報の取得にはブラウザの許可が必要です。

#### エラーハンドリング
以下のエラーコードに対応しています：
- `PERMISSION_DENIED` (1): ユーザーが許可を拒否 → エラーページへリダイレクト
- `POSITION_UNAVAILABLE` (2): GPSオフ等で位置情報が取得できない → エラーページへリダイレクト
- `TIMEOUT` (3): タイムアウト → エラーページへリダイレクト

### 6) プライバシーと運用上の注意

- 位置情報はブラウザの権限管理下で取得されます。ユーザーへの明示が必要な場合は、ページやポリシーに記載してください。
- 室内や電波状況により測位精度が低下する場合があります。誤判定を避けるため、半径は余裕を持って設定してください。
- iOS/Safari などではユーザー操作がないタブで即座に取得できない場合があります。必要に応じて `ENABLE_HIGH_ACCURACY` の利用や UI ガイダンスを検討してください。
- 取得目的・利用範囲・保存の有無をプライバシーポリシー等で明示してください。
- モバイル環境ではWi-FiやGPSの状態によって取得に時間がかかる場合があります。`TIMEOUT_MS` は適切な値（推奨: 6000ms以上）に設定してください。


